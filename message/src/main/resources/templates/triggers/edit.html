<#body>
<style>
    .template-item {
        padding: 5px 0;
    }
    .template-group {
        padding-bottom: 30px;
        border-bottom: 1px solid #ddd;
    }
</style>
<script type="text/javascript">
    /**
     * 检查市场-系统-场景对应的关系是否不存在
     */
    function checkNotExist() {
        var id = $('#modifyId').val();
        if (null != id){
            var marketCode = $('#marketCode').combobox("getValue");
            var systemCode = $('#systemCode').combobox("getValue");
            var sceneCode = $('#sceneCode').combobox("getValue");
            if (null != marketCode && null != systemCode && null != sceneCode){
                $.ajax({
                    type: "POST",
                    url: "${contextPath}/triggers/checkNotExist.action",
                    data: {marketCode:marketCode,systemCode:systemCode,sceneCode:sceneCode,selfId:id},
                    processData:true,
                    dataType: "json",
                    async : true,
                    success: function (ret) {
                        if(!ret.success){
                            swal('错误',"市场-系统-场景对应关系已存在，不能重复添加", 'error');
                            return;
                        }
                    },
                    error: function(){
                        swal('错误', '远程访问失败', 'error');
                    }
                });
            }
        }
    }

    // 市场改变
    function marketOriginChange(){
        // 检查市场-系统-场景对应的关系是否不存在
        checkNotExist();
        originChange();
    }

    // 纯整数值类型数组是否包含另一个数组
    function arrIncludes(arr1, arr2) {
        return arr2.every(val => arr1.includes(parseInt(val)));
    }

    // 来源改变
    function originChange() {
        var marketCode = $('#marketCode').combobox("getValue");
        if (null == marketCode || ''==marketCode){
            return;
        }
        let element;
        if ($(this).attr('id') === 'channel') {
            element = $(this);
        } else {
            element = $('#marketCode');
        }
        // easyui事件直接在页面元素内联上调用，拿到$(this)
        if($(this).attr('id') === 'channel') {
            console.info("------ channel");
            var channel = $(this).combobox('getValue');
            $.ajax({
                type: "POST",
                url: "${contextPath}/triggers/getChannelKey.action",
                data: {marketCode:marketCode,channel:channel},
                processData:true,
                dataType: "json",
                async : true,
                success: function (ret) {
                    if(ret.success){
                        //获取 ret.data
                        let data = [];
                        ret.data.forEach(function(el, index){
                            data.push({text: el.accessKey, value: el.id});
                        });
                        $(element).parents('.template-group').find('#marketChannelIds').combobox('loadData', data);
                        var t_id = $(element).parents('.template-group').find('#templateId').val();
                        if ($('#modifyId').val() === '' || typeof(t_id) == "undefined" ||  t_id === '') {
                            console.info("------channel clear");
                            $(element).parents('.template-group').find('#marketChannelIds').combobox('clear');
                        }
                        // var isFirst = $(element).parents('.template-group').find('#isFirst');
                        // if (!isFirst.val() || isFirst.val() == 'false'){
                        //     var options = $(element).parents('.template-group').find('#marketChannelIds').combobox("options");
                        //     var bindData = options.attributes.binddata;
                        //     $(element).parents('.template-group').find('#marketChannelIds').combobox("setValues", bindData.split(","));
                        //     isFirst.val('false');
                        // } else {
                        //     $(element).parents('.template-group').find('#marketChannelIds').combobox('clear');
                        // }
                    }else{
                        swal('错误',ret.result, 'error');
                    }
                },
                error: function(){
                    swal('错误', '远程访问失败', 'error');
                }
            });
        } else {
            console.info("------ not channel");
            $.each($('.channel'), function(index,el){
                var channel = $(el).parents('.template-group').find('#channel').combobox('getValue');
                $.ajax({
                    type: "POST",
                    url: "${contextPath}/triggers/getChannelKey.action",
                    data: {marketCode:marketCode,channel:channel},
                    processData:true,
                    dataType: "json",
                    async : true,
                    success: function (ret) {
                        if(ret.success){
                            //获取 ret.data
                            let data = [];
                            ret.data.forEach(function(el, index){
                                data.push({text: el.accessKey, value: el.id});
                            });
                            $(el).parents('.template-group').find('#marketChannelIds').combobox('loadData', data );
                            var t_id = $(el).parents('.template-group').find('#templateId').val();
                            if ($('#modifyId').val() === '' || typeof(t_id) == "undefined" ||  t_id === '') {
                                console.info("------ not channel clear");
                                $(el).parents('.template-group').find('#marketChannelIds').combobox('clear');
                            }
                        }else{
                            swal('错误',ret.result, 'error');
                        }
                    },
                    error: function(){
                        swal('错误', '远程访问失败', 'error');
                    }
                });
            })
        }
    }

</script>


<div class="easyui-layout" >
    <div id="nav" style="padding-left:15px;padding-top:10px;" align="left">
        <#nav/>
    </div>
    <!-- 基本信息表单 -->
    <div align="center">

        <div class="">
            <a href="#" class="easyui-linkbutton" iconCls="icon-save" id="record-save-btn" >保存</a>&nbsp;&nbsp;
            <a href="${contextPath}/triggers/index.html" class="easyui-linkbutton" iconCls="icon-back" id="record-back-btn" >返回</a>
        </div>
        <div  class="easyui-panel" style="width: 96%;" title="基本信息" border="false" >
            <!--<form action=""></form>-->
            <form id="_form" class="easyui-form" method="post" fit="true">
                <div class="templatewrap" id="templatewrap" style="width: 360px;">
                    <div class="template-base">
                        <input name="id" id="modifyId" value="${triggers.id!}" type="hidden">
                        <div class="template-item">
                            <input  name="marketCode" id="marketCode" style="width:100%" labelAlign="right" panelWidth="auto" panelHeight="auto" editable="false" required="true" data-options="label:'&lowast;市场:',onLoadSuccess:onComboLoadSuccessSelectOne,onChange:marketOriginChange" />
                            <#comboProvider _id="marketCode" _provider='firmProvider' _queryParams='{required:true}' _value="${triggers.marketCode!}" />
                        </div>
                        <div class="template-item">
                            <input name="systemCode" id="systemCode" style="width:100%" labelAlign="right" panelWidth="auto" panelHeight="auto" editable="false" required="true" data-options="label:'&lowast;所属系统:',onLoadSuccess:onComboLoadSuccessSelectOne,onChange:checkNotExist" />
                            <#comboProvider _id="systemCode" _provider='dataDictionaryValueProvider' _queryParams='{dd_code:"system_code",required:true}' _value="${triggers.systemCode!}"/>
                        </div>
                        <div class="template-item">
                            <input name="sceneCode" id="sceneCode" style="width:100%" labelAlign="right" panelWidth="auto" panelHeight="auto" editable="false" required="true" data-options="label:'&lowast;应用场景:',onLoadSuccess:onComboLoadSuccessSelectOne,onChange:checkNotExist" />
                            <#comboProvider _id="sceneCode" _provider='dataDictionaryValueProvider' _queryParams='{dd_code:"message_scene",required:true}' _value="${triggers.sceneCode!}"/>
                        </div>
                        <div class="template-item">
                            <input name="whitelist" id="whitelist" style="width:100%" labelAlign="right" panelWidth="auto" panelHeight="auto" editable="false" required="true" data-options="label:'&lowast;应用白名单:',onLoadSuccess:onComboLoadSuccessSelectOne" />
                            <#comboProvider _id="whitelist" _provider='booleanProvider' _queryParams='{required:true}' _value="${triggers.whitelist!}"/>
                        </div>
                    </div>
                    <div style="padding-top: 50px"></div>
                    <%if (has(triggersTemplateList)){ for(triggersTemplate in triggersTemplateList){%>
                        <div class="template-group">
                            <h4 class="template-group-title">模板</h4>
                            <input type="hidden" name="templateId" id="templateId" value="${triggersTemplate.id}" >
                            <div class="template-item">
                                <input class="easyui-combobox" id="channel" name="channel" style="width:100%" labelAlign="right" panelWidth="auto" panelHeight="auto" editable="false" required="true" data-options="cls: 'channel',label:'&lowast;模板来源:',onLoadSuccess:onComboLoadSuccessSelectOne,onChange:originChange,
                                        url:'${contextPath}/provider/getLookupList.action',
                                        method:'POST',
                                        onLoadSuccess:function(){ $(this).combobox('select', '${triggersTemplate.channel}');},
                                        queryParams: {provider: 'marketChannelProvider',queryParams:'{required:true}'}" />
                            </div>
                            <div class="template-item">
                                <!-- 是否首次进入页面 -->
                                <input type="hidden" id="isFirst" value="${isFirst!}">
                                <input class="easyui-combobox" id="marketChannelIds" name="marketChannelIds" style="width:100%" labelAlign="right" panelWidth="auto" panelHeight="auto" editable="false" required="true" data-options="cls: 'marketChannelIds',label:'&lowast;AccessKey:',multiple:true,attributes:{'binddata':'${triggersTemplate.marketChannelIds}'},
                                 onLoadSuccess:function(){
                                    var isFirst = $(this).parents('.template-group').find('#isFirst').val();
                                    var datas = $(this).combobox('getData');
                                    if(null == datas || datas.length < 1){
                                        $(this).combobox('clear');
                                        return;
                                    }
                                    console.info('------datas---- ' + datas);
                                    if (isFirst && isFirst === 'true'){
                                        $(this).combobox('setValues', [${triggersTemplate.marketChannelIds}]);
                                        $(this).parents('.template-group').find('#isFirst').val('false');
                                        console.info('------isFirst true');
                                    }else{
                                        console.info('------isFirst---'+ isFirst);
                                        console.info('------marketChannelIds---'+ ${triggersTemplate.marketChannelIds});
                                        $(this).combobox('clear');
                                    }
                                  }
                                " />
                            </div>
                            <div class="template-item">
                                <input class="easyui-textbox" name="templateName" value="${triggersTemplate.templateName!}" style="width:100%" labelAlign="right" data-options="label:'模板名称:',validType:'length[0,50]'" />
                            </div>
                            <div class="template-item">
                                <input class="easyui-textbox" name="templateCode" value="${triggersTemplate.templateCode!}" style="width:100%" labelAlign="right" data-options="label:'模板CODE:',validType:'length[0,20]'" />
                            </div>
                            <div class="template-item">
                                <input class="easyui-textbox" name="templateContent" value="${triggersTemplate.templateContent!}" style="width:100%" labelAlign="right" required="true" data-options="label:'&lowast;模板内容:', height: '80px', multiline: true,validType:'length[1,255]'" />
                            </div>
                            <div class="edit-limit">
                                <a href="#" class="easyui-linkbutton template-plus-btn" data-options="iconCls:'icon-add'">增加</a>
                                <a href="#" class="easyui-linkbutton template-minus-btn" data-options="iconCls:'icon-remove'">删除</a>
                            </div>
                        </div>
                    <%}}else{%>
                        <div class="template-group">
                            <h4 class="template-group-title">模板</h4>
                            <input type="hidden" name="templateId" id="templateId">
                            <div class="template-item">
                                <input class="easyui-combobox" id="channel" name="channel" style="width:100%" labelAlign="right" panelWidth="auto" panelHeight="auto" editable="false" required="true" data-options="cls:'channel', label:'&lowast;模板来源:',onLoadSuccess:onComboLoadSuccessSelectOne,onChange:originChange,
                                    url:'${contextPath}/provider/getLookupList.action',
                                    method:'POST',
                                    queryParams: {provider: 'marketChannelProvider',queryParams:'{required:true}'}" />
                            </div>
                            <div class="template-item">
                                <input class="easyui-combobox" id="marketChannelIds" name="marketChannelIds" style="width:100%" labelAlign="right" panelWidth="auto" panelHeight="auto" editable="false" required="true" data-options="textField:'text',valueField:'value', label:'&lowast;AccessKey:',multiple:true" />
                            </div>
                            <div class="template-item">
                                <input class="easyui-textbox" name="templateName" style="width:100%" labelAlign="right" data-options="label:'模板名称:',validType:'length[0,50]'" />
                            </div>
                            <div class="template-item">
                                <input class="easyui-textbox" name="templateCode" style="width:100%" labelAlign="right" data-options="label:'模板CODE:',validType:'length[0,20]'" />
                            </div>
                            <div class="template-item">
                                <input class="easyui-textbox" name="templateContent" style="width:100%" labelAlign="right" required="true" data-options="label:'&lowast;模板内容:', height: '80px', multiline: true,validType:'length[1,255]'" />
                            </div>
                            <div class="edit-limit">
                                <a href="#" class="easyui-linkbutton template-plus-btn" data-options="iconCls:'icon-add'">增加</a>
                                <a href="#" class="easyui-linkbutton template-minus-btn" data-options="iconCls:'icon-remove'">删除</a>
                            </div>
                        </div>
                    <%}%>

                </div>
            </form>
        </div>
    </div>
</div>

<#triggers_editJs />
</#body>